
<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>തദ്ദേശ തെരഞ്ഞെടുപ്പ് ഫലം</title>
    <!-- Tailwind CSS ഉൾപ്പെടുത്തുന്നു -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* മലയാളം ഫോണ്ടിനായി */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@100..900&display=swap');
        
        /* പൊതുവായ സ്റ്റൈലുകൾ */
        body {
            font-family: 'Noto Sans Malayalam', sans-serif;
            background-color: #f0f4f8; /* ലൈറ്റ് ബാക്ക്ഗ്രൗണ്ട് */
        }
        
        .widget-container {
            max-width: 1000px; /* പുതിയ ബാനറിൻ്റെ വീതിക്ക് അനുസരിച്ച് മാറ്റി */
            margin: 20px auto;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        /* ബാനർ സ്റ്റൈൽ */
        .widget-banner img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* പുതിയ ബട്ടൺ കണ്ടെയ്‌നർ സ്റ്റൈൽ */
        .button-container {
            display: flex;
            justify-content: center; 
            padding: 0; 
            background-color: white;
        }
        
        /* LIVE RESULT ബട്ടൺ സ്റ്റൈൽ */
        .live-result-button {
            width: 100%; /* വീതി 100% ആയി നിലനിർത്തുന്നു */
            max-width: 100%; 
            padding: 8px; /* ഉയരം കുറയ്ക്കാൻ പാഡിംഗ് 8px ആക്കി */
            background-color: #dc2626; /* പുതിയ നിറം: കടും ചുവപ്പ് (Red-700) */
            color: white;
            font-weight: 800;
            border: none;
            border-radius: 0; 
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-transform: uppercase;
            font-size: 1.1rem;
            box-shadow: none; /* ബോക്സ് ഷാഡോ ഒഴിവാക്കി */
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        
        .live-result-button:hover {
            background-color: #b91c1c; /* ഡാർക്കർ റെഡ് */
            transform: translateY(0); 
        }

        /* ഗ്രീൻ ബീക്കൺ ഡോട്ട് സ്റ്റൈൽ */
        .live-dot {
            height: 12px;
            width: 12px;
            background-color: #10b981; /* Emerald Green */
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            position: relative;
        }

        /* പൾസ് (ബീക്കൺ) അനിമേഷൻ */
        .live-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            border-radius: 50%;
            background-color: #10b981;
            animation: pulse 1.5s infinite;
            z-index: -1;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(2.0);
                opacity: 0;
            }
        }

        /* പാർട്ടി ബോക്സുകൾക്കായി ഫ്ലെക്സ് ലേഔട്ട് */
        .party-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 10px 10px;
        }

        /* ഓരോ ബ്ലോക്കിനും ട്വിൻ്റ് ഇഫക്റ്റ് നൽകാൻ കസ്റ്റം ക്ലാസ്സുകൾ */
        .panchayath-header { background-color: #ef4444; } /* റെഡ് */
        .corporation-header { background-color: #22c55e; } /* ഗ്രീൻ */
        .nagarasabha-header { background-color: #3b82f6; } /* ബ്ലൂ */
        .block-panchayath-header { background-color: #f97316; } /* ഓറഞ്ച് */
        .jilla-panchayath-header { background-color: #8b5cf6; } /* വയലറ്റ് */
        
        .block-header {
            padding: 12px 15px;
            color: white;
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Total Count Style */
        .total-count {
            font-size: 1rem;
            font-weight: 800;
            padding: 5px 10px;
            background-color: #e5e7eb;
            color: #374151;
            border-radius: 6px;
        }
        
        /* പാർട്ടി ബോക്സ് സ്റ്റൈൽ */
        .party-box {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s;
        }

        .party-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* പാർട്ടിയുടെ ഹെഡർ വലുതാക്കുകയും കറുപ്പ് നിറം നൽകുകയും ചെയ്യുന്നു */
        .party-name {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 2px;
            color: #1f2937;
        }

        .count {
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        /* ഓരോ പാർട്ടിക്കുമുള്ള ലൈറ്റ് ട്വിൻ്റ് */
        .ldf-tint { background-color: #fef2f2; }
        .udf-tint { background-color: #eff6ff; }
        .nda-tint { background-color: #fffbeb; }
        .oth-tint { background-color: #f3f4f6; }
        
        /* ഓരോ പാർട്ടിക്കും കൗണ്ടിനുള്ള നിറങ്ങൾ */
        .ldf-count { color: #dc2626; }
        .udf-count { color: #1d4ed8; }
        .nda-count { color: #fbbf24; }
        .oth-count { color: #6b7280; }

        /* ഡ്രോപ്പ്ഡൗൺ CSS for Result Panels */
        .result-panels {
            transition: max-height 0.7s ease-in-out, opacity 0.5s ease-out;
            max-height: 1500px; /* ആവശ്യത്തിന് വലിയ മൂല്യം */
            opacity: 1;
            overflow: hidden;
        }

        .result-panels.hidden-results {
            max-height: 0;
            opacity: 0;
        }


        /* വിശകലന വിഭാഗത്തിനുള്ള സ്റ്റൈലുകൾ */
        .analysis-section {
            padding: 15px;
            background-color: #f8f8ff;
            border-top: 2px solid #3b82f6;
        }
        .analysis-output {
            margin-top: 10px;
            padding: 15px;
            border: 1px dashed #3b82f6;
            border-radius: 8px;
            min-height: 80px;
            background-color: #ffffff;
            white-space: pre-wrap;
            /* Animation for smooth reveal */
            transition: all 0.3s ease-out;
            opacity: 1;
            max-height: 1000px;
        }
        /* വിശകലനം ഹൈഡ് ചെയ്യുമ്പോൾ ഉപയോഗിക്കുന്ന ക്ലാസ്സ് */
        .analysis-output.hidden {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border: none;
            overflow: hidden;
            margin-top: 0;
        }

    </style>
</head>
<body>

<div class="widget-container">
    
    <!-- ബാനർ - പുതിയ URL, പുതിയ വീതി -->
    <div class="widget-banner">
        <img src="https://images.assettype.com/newsmalayalam/2025-11-10/6mc0x5t2/keralalocalbodypoll2025.jpg" alt="തദ്ദേശ തെരഞ്ഞെടുപ്പ് ബാനർ" onerror="this.onerror=null;this.src='https://placehold.co/1000x250/000/fff?text=Election+Banner+Placeholder';">
    </div>

    <!-- LIVE RESULT ബട്ടൺ കണ്ടെയ്‌നർ -->
    <div class="button-container">
        <button id="liveResultButton" class="live-result-button">
            <!-- ഗ്രീൻ ബീക്കൺ ഡോട്ട് -->
            <span class="live-dot"></span>
            LIVE RESULT CLICK HERE ▼
        </button>
    </div>
    
    <!-- ഡാറ്റാ ലോഡിംഗ് സ്റ്റാറ്റസ് -->
    <div id="dataStatus" class="text-center text-xs py-1 text-gray-500 bg-gray-100">LIVE UPDATED - 00-00-0000 00:00:00 AM</div>


    <!-- Result Panels Container - തുടക്കത്തിൽ മറഞ്ഞിരിക്കുന്നു -->
    <div id="resultPanels" class="result-panels hidden-results">

        <!-- 1. പഞ്ചായത്ത് (Total 941) -->
        <div class="result-block">
            <div class="block-header panchayath-header">
                <span>പഞ്ചായത്ത്</span>
                <span class="total-count">Total 941</span>
            </div>
            <div class="party-grid" data-body="പഞ്ചായത്ത്" data-total="941">
                <div class="party-box ldf-tint"><div class="party-name">LDF</div><div class="count ldf-count" data-party="LDF">0</div></div>
                <div class="party-box udf-tint"><div class="party-name">UDF</div><div class="count udf-count" data-party="UDF">0</div></div>
                <div class="party-box nda-tint"><div class="party-name">NDA</div><div class="count nda-count" data-party="NDA">0</div></div>
                <div class="party-box oth-tint"><div class="party-name">OTH</div><div class="count oth-count" data-party="OTH">0</div></div>
            </div>
        </div>
        
        <!-- 2. കോർപ്പറേഷൻ (Total 6) -->
        <div class="result-block">
            <div class="block-header corporation-header">
                <span>കോർപ്പറേഷൻ</span>
                <span class="total-count">Total 6</span>
            </div>
            <div class="party-grid" data-body="കോർപ്പറേഷൻ" data-total="6">
                <div class="party-box ldf-tint"><div class="party-name">LDF</div><div class="count ldf-count" data-party="LDF">0</div></div>
                <div class="party-box udf-tint"><div class="party-name">UDF</div><div class="count udf-count" data-party="UDF">0</div></div>
                <div class="party-box nda-tint"><div class="party-name">NDA</div><div class="count nda-count" data-party="NDA">0</div></div>
                <div class="party-box oth-tint"><div class="party-name">OTH</div><div class="count oth-count" data-party="OTH">0</div></div>
            </div>
        </div>
        
        <!-- 3. നഗരസഭ (Total 87) -->
        <div class="result-block">
            <div class="block-header nagarasabha-header">
                <span>നഗരസഭ</span>
                <span class="total-count">Total 87</span>
            </div>
            <div class="party-grid" data-body="നഗരസഭ" data-total="87">
                <div class="party-box ldf-tint"><div class="party-name">LDF</div><div class="count ldf-count" data-party="LDF">0</div></div>
                <div class="party-box udf-tint"><div class="party-name">UDF</div><div class="count udf-count" data-party="UDF">0</div></div>
                <div class="party-box nda-tint"><div class="party-name">NDA</div><div class="count nda-count" data-party="NDA">0</div></div>
                <div class="party-box oth-tint"><div class="party-name">OTH</div><div class="count oth-count" data-party="OTH">0</div></div>
            </div>
        </div>
        
        <!-- 4. ബ്ലോക്ക് പഞ്ചായത്ത് (Total 152) -->
        <div class="result-block">
            <div class="block-header block-panchayath-header">
                <span>ബ്ലോക്ക് പഞ്ചായത്ത്</span>
                <span class="total-count">Total 152</span>
            </div>
            <div class="party-grid" data-body="ബ്ലോക്ക് പഞ്ചായത്ത്" data-total="152">
                <div class="party-box ldf-tint"><div class="party-name">LDF</div><div class="count ldf-count" data-party="LDF">0</div></div>
                <div class="party-box udf-tint"><div class="party-name">UDF</div><div class="count udf-count" data-party="UDF">0</div></div>
                <div class="party-box nda-tint"><div class="party-name">NDA</div><div class="count nda-count" data-party="NDA">0</div></div>
                <div class="party-box oth-tint"><div class="party-name">OTH</div><div class="count oth-count" data-party="OTH">0</div></div>
            </div>
        </div>

        <!-- 5. ജില്ല പഞ്ചായത്ത് (Total 14) -->
        <div class="result-block">
            <div class="block-header jilla-panchayath-header">
                <span>ജില്ല പഞ്ചായത്ത്</span>
                <span class="total-count">Total 14</span>
            </div>
            <div class="party-grid" data-body="ജില്ല പഞ്ചായത്ത്" data-total="14">
                <div class="party-box ldf-tint"><div class="party-name">LDF</div><div class="count ldf-count" data-party="LDF">0</div></div>
                <div class="party-box udf-tint"><div class="party-name">UDF</div><div class="count udf-count" data-party="UDF">0</div></div>
                <div class="party-box nda-tint"><div class="party-name">NDA</div><div class="count nda-count" data-party="NDA">0</div></div>
                <div class="party-box oth-tint"><div class="party-name">OTH</div><div class="count oth-count" data-party="OTH">0</div></div>
            </div>
        </div>
    </div>
    <!-- End of resultPanels -->


    <!-- Gemini API Powered Analysis Section -->
    <div class="analysis-section">
        <!-- വിശകലനം തയ്യാറാക്കുക എന്ന ബോക്സ് ഒഴിവാക്കി, ബട്ടൺ മാത്രം നിലനിർത്തി -->
        <button id="analyzeButton" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
            തെരഞ്ഞെടുപ്പ് വിശകലനം ✨
        </button>
        <!-- വിശകലനം പൂർത്തിയാവുമ്പോൾ മാത്രം ഡ്രോപ്പ്-ഡൗൺ ആയി ദൃശ്യമാക്കാൻ 'hidden' ക്ലാസ് ചേർത്തു. -->
        <div id="analysisOutput" class="analysis-output text-sm text-gray-800 hidden">
            <!-- വിശകലനം ഇവിടെ ദൃശ്യമാകും -->
        </div>
    </div>
    
</div>

<script>
    // --- Data Source and Gemini API Configuration ---
    // Google Sheets-ൻ്റെ CSV Export URL (പുതിയ ലിങ്ക് ഉപയോഗിക്കുന്നു)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1n2i4ExiyLtIT_ZM6-RwN0g0IRg9iUkM80661S24fQJ8/export?format=csv&gid=764343976";
    const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const API_KEY = "AIzaSyDTG0jvhdikIFVsGeeRlBMoyS4XVqSfVJA"; // User-provided API Key

    // --- Utility Functions ---

    // Helper for Exponential Backoff (retries API calls)
    async function exponentialBackoffFetch(url, options, maxRetries = 5) {
        let lastError = null;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) { // Too Many Requests
                    throw new Error("Rate limit exceeded");
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return response;
            } catch (error) {
                lastError = error;
                // Wait for an exponentially increasing time (1s, 2s, 4s, ...)
                const delay = Math.pow(2, i) * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        throw new Error(`Failed to fetch data after ${maxRetries} retries. Last error: ${lastError.message}`);
    }


    // Function to extract current results from the DOM (used for Gemini Analysis)
    function getCurrentResults() {
        const results = {};
        const grids = document.querySelectorAll('.party-grid');
        
        grids.forEach(grid => {
            const bodyName = grid.dataset.body;
            const total = parseInt(grid.dataset.total, 10);
            
            const bodyResults = { Total: total }; // Use capitalized 'Total' for JSON output clarity
            grid.querySelectorAll('.count').forEach(countDiv => {
                const party = countDiv.dataset.party;
                bodyResults[party] = parseInt(countDiv.textContent, 10); 
            });
            results[bodyName] = bodyResults;
        });
        return results;
    }

    // --- CSV Data Processing ---

    // Function to update the DOM with fetched results
    function updateResults(data) {
        const bodyMap = {
            'PANCHAYATH': 'പഞ്ചായത്ത്',
            'CORPORATION': 'കോർപ്പറേഷൻ',
            'NAGARASABHA': 'നഗരസഭ',
            'BLOCK PANCHAYATH': 'ബ്ലോക്ക് പഞ്ചായത്ത്',
            'DISTRICT PANCHAYATH': 'ജില്ല പഞ്ചായത്ത്'
        };

        const partyOrder = ['LDF', 'UDF', 'NDA', 'OTH'];
        
        data.forEach(item => {
            const bodyValue = item.BODY; 
            
            const malayalamBodyName = bodyMap[bodyValue.toUpperCase()];
            
            if (malayalamBodyName) {
                const grid = document.querySelector(`.party-grid[data-body="${malayalamBodyName}"]`);
                if (grid) {
                    partyOrder.forEach(party => {
                        const countElement = grid.querySelector(`.count[data-party="${party}"]`);
                        if (countElement) {
                            const count = parseInt(item[party], 10) || 0;
                            countElement.textContent = count;
                        }
                    });
                }
            }
        });

        // Current time and date for live status (New Feature)
        const now = new Date();
        // Date and Time formatting for "LIVE UPDATED - Date and Time" format
        const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
        const dateStr = now.toLocaleDateString('en-GB', dateOptions).replace(/\//g, '-'); // Use standard format
        const timeStr = now.toLocaleTimeString('en-US', timeOptions); // Use standard time format

        document.getElementById('dataStatus').textContent = `LIVE UPDATED - ${dateStr} ${timeStr}`;
    }


    // Function to fetch CSV data and parse it
    async function fetchAndProcessCSV() {
        const dataStatus = document.getElementById('dataStatus');
        dataStatus.textContent = "ഡാറ്റാ ലോഡ് ചെയ്യുന്നു...";
        
        try {
            const response = await exponentialBackoffFetch(CSV_URL);
            const csvText = await response.text();
            
            // --- Robust CSV Parsing Logic (Adjusted for 6 columns in source sheet) ---
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("No data found in CSV.");

            // New headers for our simplified structure (excluding the Total column from the party counts)
            const new_headers = ['BODY', 'LDF', 'UDF', 'NDA', 'OTH']; 
            
            let modified_data = new_headers.join(',') + '\n'; 
            
            for (let i = 1; i < lines.length; i++) {
                const row_data = lines[i].trim().split(',').map(c => c.trim().replace(/\"/g, ''));
                
                // Assuming the source sheet has 6 columns: [Body, Total, LDF, UDF, NDA, OTH]
                if (row_data.length >= 6) {
                    // Column 1 (Index 0): BODY
                    // Column 3 (Index 2): LDF (Actual LDF count from sheet column 3)
                    // Column 4 (Index 3): UDF (Actual UDF count from sheet column 4)
                    // Column 5 (Index 4): NDA (Actual NDA count from sheet column 5)
                    // Column 6 (Index 5): OTH (Actual OTH count from sheet column 6)
                    
                    const processed_row = [
                        row_data[0], // BODY
                        row_data[2], // LDF (Actual LDF count from sheet column 3)
                        row_data[3], // UDF (Actual UDF count from sheet column 4)
                        row_data[4], // NDA (Actual NDA count from sheet column 5)
                        row_data[5]  // OTH (Actual OTH count from sheet column 6)
                    ].join(',');
                    
                    modified_data += processed_row + '\n';
                } else if (any(line.strip())) {
                    // console.warn(`Skipping malformed row (expected 6 columns, got ${row_data.length}): ${lines[i].trim()}`);
                }
            }
            
            // Simple parsing to array of objects {BODY: 'Panchayath', LDF: '941', ...}
            const dataObjects = [];
            const dataLines = modified_data.trim().split('\n');
            const keys = dataLines[0].split(',');

            for (let i = 1; i < dataLines.length; i++) {
                const values = dataLines[i].split(',');
                if (values.length === keys.length) {
                    let obj = {};
                    keys.forEach((key, index) => {
                        obj[key] = values[index];
                    });
                    dataObjects.push(obj);
                }
            }
            // --- End of CSV Parsing Logic ---

            updateResults(dataObjects);

        } catch (error) {
            console.error("CSV Fetch Error:", error);
            dataStatus.textContent = `ഡാറ്റാ ലോഡിംഗ് പിശക്: ${error.message}`;
            dataStatus.classList.add('text-red-600');
        }
    }


    // --- Gemini API Analysis Function ---

    async function generateAnalysis() {
        const analyzeButton = document.getElementById('analyzeButton');
        const outputDiv = document.getElementById('analysisOutput');

        analyzeButton.disabled = true;
        
        // Show the output div and set the loading message
        outputDiv.classList.remove('hidden');
        outputDiv.innerHTML = '<div class="text-center py-4 text-indigo-600 font-medium">വിശകലനം തയ്യാറാക്കുന്നു... <span class="animate-pulse">...</span></div>';

        const currentResults = getCurrentResults();
        
        const systemPrompt = "You are an experienced political analyst specializing in Kerala local body elections. Your task is to provide a brief, professional, high-level summary and projection based on the raw data provided. The analysis must be strictly in Malayalam and professional in a single paragraph, focusing on the implications of the distribution across different body types (Panchayats, Corporations, etc.) based on the actual seat counts. Use the data exactly as provided.";
        
        const userQuery = `Analyze the current results for the Kerala Local Body Elections and provide an initial high-level projection and analysis. Note the trends across different types of local bodies. \n\nRaw Data:\n${JSON.stringify(currentResults, null, 2)}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;

        try {
            const response = await exponentialBackoffFetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const analysisText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (analysisText) {
                outputDiv.textContent = analysisText;
            } else {
                outputDiv.textContent = "വിശകലനം ലഭ്യമാക്കുന്നതിൽ പിശക് സംഭവിച്ചു. (Error: No response text)";
            }

        } catch (error) {
            console.error("Gemini API Error:", error);
            outputDiv.textContent = `വിശകലനം ലഭ്യമാക്കുന്നതിൽ പിശക് സംഭവിച്ചു: ${error.message}`;
        } finally {
            analyzeButton.disabled = false;
        }
    }
    
    // --- Event Listeners and Initialization ---

    // Event listener for LIVE RESULT button
    document.getElementById('liveResultButton').addEventListener('click', () => {
        const resultPanels = document.getElementById('resultPanels');
        const button = document.getElementById('liveResultButton');

        // Toggle visibility class
        resultPanels.classList.toggle('hidden-results');
        
        // Update button text with arrow
        const arrow = resultPanels.classList.contains('hidden-results') ? '▼' : '▲';
        button.innerHTML = `<span class="live-dot"></span>LIVE RESULT CLICK HERE ${arrow}`;
    });

    // Event Listener for the Gemini analyze button
    document.getElementById('analyzeButton').addEventListener('click', generateAnalysis);

    // Initial Data Fetch on load
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndProcessCSV();
        
        // Initial button text setup with dot (since the dot is now part of the HTML)
        const button = document.getElementById('liveResultButton');
        button.innerHTML = `<span class="live-dot"></span>LIVE RESULT CLICK HERE ▼`;

        // Set up live update interval (every 15 seconds)
        setInterval(fetchAndProcessCSV, 15000);
    });
    
</script>

</body>
</html>
